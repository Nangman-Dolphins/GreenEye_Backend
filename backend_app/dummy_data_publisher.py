import paho.mqtt.client as mqtt
import redis
import time
import json
import random
import os
import socket
from datetime import datetime
from dotenv import load_dotenv
import re

# .env íŒŒì¼ ë¡œë“œ
load_dotenv()

# --- ë”ë¯¸ ë°ì´í„° ì„¤ì • ---
DEVICE_IDS = ["6c18", "eef2", "00a9"]
PLANT_CONDITIONS = [
    {
        "status": "healthy",
        "comment": "ì‹ë¬¼ì´ ê±´ê°•í•˜ê²Œ ìë¼ê³  ìˆì–´ìš”! ğŸŒ±",
        "confidence": 0.92
    },
    {
        "status": "need_water",
        "comment": "ë¬¼ì„ ì¡°ê¸ˆ ë” ì£¼ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”. ğŸ’§",
        "confidence": 0.85
    },
    {
        "status": "too_much_water",
        "comment": "ìˆ˜ë¶„ì´ ë„ˆë¬´ ë§ì•„ìš”. ë©°ì¹  ë™ì•ˆ ë¬¼ì„ ì£¼ì§€ ë§ì•„ì£¼ì„¸ìš”. ğŸ’¦",
        "confidence": 0.88
    },
    {
        "status": "need_light",
        "comment": "ë¹›ì´ ë¶€ì¡±í•´ ë³´ì…ë‹ˆë‹¤. í–‡ë¹›ì´ ì˜ ë“œëŠ” ê³³ìœ¼ë¡œ ì˜®ê²¨ì£¼ì„¸ìš”. â˜€ï¸",
        "confidence": 0.87
    },
    {
        "status": "optimal",
        "comment": "í† ì–‘ ìƒíƒœê°€ ìµœì ì…ë‹ˆë‹¤. ğŸ‘",
        "confidence": 0.95
    }
]

# --- í™˜ê²½ ë³€ìˆ˜ ---
MQTT_BROKER_HOST = "localhost"  # MQTT ë¸Œë¡œì»¤ í˜¸ìŠ¤íŠ¸ë¥¼ localhostë¡œ ê³ ì •
MQTT_BROKER_PORT = 1883        # ê¸°ë³¸ MQTT í¬íŠ¸

MQTT_USERNAME = os.getenv('MQTT_USERNAME', 'greeneye_user')
MQTT_PASSWORD = os.getenv('MQTT_PASSWORD', 'kitel1976!')

# Redis ì—°ê²° ì„¤ì •
REDIS_HOST = os.getenv("REDIS_HOST", "localhost")
REDIS_PORT = int(os.getenv("REDIS_PORT", "6379"))
REDIS_PASSWORD = os.getenv("REDIS_PASSWORD")

# --- MQTT í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ---
mqtt_client = mqtt.Client()  # ê¸°ë³¸ ë²„ì „ ì‚¬ìš©

def connect_redis():
    """Redis ì—°ê²°"""
    try:
        client = redis.Redis(
            host="localhost",  # Redis í˜¸ìŠ¤íŠ¸ë¥¼ localhostë¡œ ê³ ì •
            port=REDIS_PORT,
            password=REDIS_PASSWORD,
            decode_responses=True
        )
        client.ping()  # ì—°ê²° í…ŒìŠ¤íŠ¸
        print(f"Redis connected at {REDIS_HOST}:{REDIS_PORT}")
        return client
    except Exception as e:
        print(f"Redis connection failed: {e}")
        return None

def on_mqtt_connect(client, userdata, flags, rc):
    """MQTT ë¸Œë¡œì»¤ ì ‘ì† ê²°ê³¼ ì½œë°±"""
    if rc == 0:
        print(f"Dummy sensor/image connected to MQTT Broker at {MQTT_BROKER_HOST}:{MQTT_BROKER_PORT}")
    else:
        print(f"Dummy sensor/image failed to connect, return code {rc}")
        print("Check your MQTT broker status or credentials in .env file.")

def make_sensor_payload():
    """ì„¼ì„œ ë°ì´í„° ìƒì„±"""
    return {
        "bat_level": 50, 
        "amb_temp": round(random.uniform(20.0, 30.0), 2),
        "amb_humi": round(random.uniform(50.0, 80.0), 2),
        "amb_light": round(random.uniform(800, 2000), 2),
        "soil_temp": round(random.uniform(18.0, 25.0), 2),
        "soil_humi": round(random.uniform(50.0, 90.0), 2),
        "soil_ec": round(random.uniform(0.5, 3.0), 2)
    }

def generate_ai_inference(device_id: str, sensor_data: dict):
    """ì„¼ì„œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AI ì¶”ë¡  ê²°ê³¼ ìƒì„±"""
    # ì„¼ì„œ ê°’ì— ë”°ë¼ ìƒíƒœ ê²°ì •
    if sensor_data["soil_humi"] < 60:
        condition = next(c for c in PLANT_CONDITIONS if c["status"] == "need_water")
    elif sensor_data["soil_humi"] > 85:
        condition = next(c for c in PLANT_CONDITIONS if c["status"] == "too_much_water")
    elif sensor_data["amb_light"] < 1000:
        condition = next(c for c in PLANT_CONDITIONS if c["status"] == "need_light")
    else:
        condition = random.choice([c for c in PLANT_CONDITIONS if c["status"] in ["healthy", "optimal"]])

    return {
        "device_id": device_id,
        "predicted_label": condition["status"],
        "comment": condition["comment"],
        "confidence": condition["confidence"],
        "timestamp": datetime.utcnow().isoformat(),
        "plant_type": "tomato",
        "sensor_context": {
            "temperature": sensor_data["amb_temp"],
            "humidity": sensor_data["amb_humi"],
            "light": sensor_data["amb_light"],
            "soil_moisture": sensor_data["soil_humi"]
        }
    }

def main():
    # Redis ì—°ê²°
    redis_client = connect_redis()
    if not redis_client:
        print("Redis connection failed. Exiting...")
        return

    # MQTT ì—°ê²° ì„¤ì •
    mqtt_client.username_pw_set(MQTT_USERNAME, MQTT_PASSWORD)
    mqtt_client.on_connect = on_mqtt_connect

    try:
        mqtt_client.connect(MQTT_BROKER_HOST, MQTT_BROKER_PORT, 60)
        mqtt_client.loop_start()
    except Exception as e:
        print(f"Could not connect to MQTT broker: {e}")
        print("Please ensure your Docker Mosquitto container is running and credentials are correct.")
        return

    print(f"\n--- Starting dummy data publishing every 5 seconds ---")
    print(f"Publishing to MQTT topic 'GreenEye/data/{{device_id}}' for {', '.join(DEVICE_IDS)}")
    print(f"Publishing to Redis with key 'latest_ai_diagnosis:{{device_id}}'\n")

    try:
        while True:
            for device_id in DEVICE_IDS:
                # 1. ì„¼ì„œ ë°ì´í„° ìƒì„± ë° MQTT ë°œí–‰
                sensor_data = make_sensor_payload()
                mqtt_client.publish(f"GreenEye/data/{device_id}", json.dumps(sensor_data))
                
                print(f"[{datetime.now().strftime('%H:%M:%S')}] Device {device_id}:")
                print("  MQTT - Sensor Values:")
                print(f"    Temperature: {sensor_data['amb_temp']}Â°C")
                print(f"    Humidity: {sensor_data['amb_humi']}%")
                print(f"    Light: {sensor_data['amb_light']} lux")
                print(f"    Soil Temp: {sensor_data['soil_temp']}Â°C")
                print(f"    Soil Humidity: {sensor_data['soil_humi']}%")
                print(f"    Soil EC: {sensor_data['soil_ec']} dS/m")

                # 2. AI ì¶”ë¡  ê²°ê³¼ ìƒì„± ë° Redis ì €ì¥
                inference = generate_ai_inference(device_id, sensor_data)
                redis_key = f"latest_ai_diagnosis:{device_id}"
                redis_client.set(redis_key, json.dumps(inference))

                print("  Redis - AI Inference:")
                print(f"    Status: {inference['predicted_label']}")
                print(f"    Confidence: {inference['confidence']:.2%}")
                print(f"    Comment: {inference['comment']}")
                print()

            time.sleep(5)

    except KeyboardInterrupt:
        print("\n--- Dummy data publishing stopped. ---")
    finally:
        mqtt_client.loop_stop()
        mqtt_client.disconnect()
        redis_client.close()
        print("MQTT and Redis connections closed.")

if __name__ == "__main__":
    main()
